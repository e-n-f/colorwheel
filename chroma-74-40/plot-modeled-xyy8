#!/usr/bin/perl

use POSIX;

$pi = 4 * atan2(1, 1);
$light =  0.070852;
$sides = 8;

@ang = (0, $pi * 1/4, $pi * 2/4, $pi * 3/4, $pi * 4/4, $pi * 5/4, $pi * 6/4, $pi * 7/4);

$sc = .5;

@d = ( "x", "x", "x", "x", "x", "x", "x", "x" );

sub scale {
	my ($x, $y) = @_;

	return sprintf("%.3f %.3f", $x * 612, $y * 612);
}

sub labtoxyz {
	my ($L, $a, $b) = @_;

	my $y = ($L + 16.0) / 116.0;
	my $y3 = POSIX::pow($y, 3.0);
	my $x = ($a / 500.0) + $y;
	my $x3 = POSIX::pow($x, 3.0);
	my $z = $y - ($b / 200.0);
	my $z3 = POSIX::pow($z, 3.0);

	if ($y3 > 0.008856) {
		$y = $y3;
	} else {
		$y = ($y - (16.0 / 116.0)) / 7.787;
	}
	if ($x3 > 0.008856) {
		$x = $x3;
	} else {
		$x = ($x - (16.0 / 116.0)) / 7.787;
	}
	if ($z3 > 0.008856) {
		$z = $z3;
	} else {
		$z = ($z - (16.0 / 116.0)) / 7.787;
	}

	my @whitepoint = ( 95.17497923187392, 100, 102.45906488893944 );

	return ( $x * $whitepoint[0], $y * $whitepoint[1], $z * $whitepoint[2] );
}

sub xyztoxyy {
	my ($X, $Y, $Z) = @_;

	$X /= 100;
	$Y /= 100;
	$Z /= 100;

	my $x = $X / ($X + $Y + $Z);
	my $y = $Y / ($X + $Y + $Z);

	return ( $x, $y, $Y );
}

sub bezier {
	my ($x0, $y0, $x1, $y1, $x2, $y2, $x3, $y3) = @_;

	if ($x0 == 0) {
		$x0 = $x1;
		$y0 = $y1;
	}
	if ($x3 == 0) {
		$x3 = $x2;
		$y3 = $y2;
	}

	# http://www.antigrain.com/research/bezier_interpolation/
	my $xc1 = ($x0 + $x1) / 2.0;
	my $yc1 = ($y0 + $y1) / 2.0;
	my $xc2 = ($x1 + $x2) / 2.0;
	my $yc2 = ($y1 + $y2) / 2.0;
	my $xc3 = ($x2 + $x3) / 2.0;
	my $yc3 = ($y2 + $y3) / 2.0;

	my $len1 = sqrt(($x1-$x0) * ($x1-$x0) + ($y1-$y0) * ($y1-$y0));
	my $len2 = sqrt(($x2-$x1) * ($x2-$x1) + ($y2-$y1) * ($y2-$y1));
	my $len3 = sqrt(($x3-$x2) * ($x3-$x2) + ($y3-$y2) * ($y3-$y2));

	if ($len1 + $len2 == 0 || $len2 + $len3 == 0) {
		print STDERR "??? $x0,$y0 $x1,$y1 $x2,$y2 $x3,$y3\n";
		return;
	}

	my $k1 = $len1 / ($len1 + $len2);
	my $k2 = $len2 / ($len2 + $len3);

	my $xm1 = $xc1 + ($xc2 - $xc1) * $k1;
	my $ym1 = $yc1 + ($yc2 - $yc1) * $k1;

	my $xm2 = $xc2 + ($xc3 - $xc2) * $k2;
	my $ym2 = $yc2 + ($yc3 - $yc2) * $k2;

	my $smooth_value = .5;

	my $ctrl1_x = $xm1 + ($xc2 - $xm1) * $smooth_value + $x1 - $xm1;
	my $ctrl1_y = $ym1 + ($yc2 - $ym1) * $smooth_value + $y1 - $ym1;

	my $ctrl2_x = $xm2 + ($xc2 - $xm2) * $smooth_value + $x2 - $xm2;
	my $ctrl2_y = $ym2 + ($yc2 - $ym2) * $smooth_value + $y2 - $ym2;

	print scale($x1, $y1) . " moveto ";
	print scale ($ctrl1_x, $ctrl1_y) . " " . scale($ctrl2_x, $ctrl2_y) . " ";
	print scale($x2, $y2) . " curveto stroke\n";
}

$data = <<'EOF'
a               = 1.43613          +/- 5.901        (410.9%)
b               = 0.330897         +/- 0.009983     (3.017%)
c               = 1.13923          +/- 0.6064       (53.23%)
d               = 1.07216          +/- 1.706        (159.1%)
e               = 0.410118         +/- 0.02981      (7.269%)
f               = 1.94086          +/- 0.7327       (37.75%)
g               = -0.032067        +/- 0.01986      (61.94%)
h               = 1.61645          +/- 1.294        (80.04%)
i               = 0.049267         +/- 0.006984     (14.18%)
j               = -1.13045         +/- 6.321        (559.2%)
k               = 0.876521         +/- 0.9926       (113.2%)
l               = 1.90072          +/- 10.16        (534.3%)
a               = -0.0333662       +/- 1.364        (4087%)
b               = 0.327812         +/- 0.02862      (8.732%)
c               = 0.659605         +/- 9.362        (1419%)
d               = 0.165623         +/- 0.2661       (160.6%)
e               = 0.346322         +/- 0.02495      (7.204%)
f               = 1.19164          +/- 0.9705       (81.44%)
g               = -0.0245794       +/- 0.01425      (57.99%)
h               = 1.29532          +/- 1.175        (90.72%)
i               = 0.038526         +/- 0.01545      (40.1%)
j               = 0.711218         +/- 9.62         (1353%)
k               = 1.47249          +/- 6.838        (464.4%)
l               = 0.923176         +/- 10.6         (1148%)
a               = 0.149664         +/- 7.831        (5232%)
b               = 0.292342         +/- 0.02892      (9.894%)
c               = 1.0605           +/- 8.531        (804.4%)
d               = 0.13883          +/- 0.2054       (147.9%)
e               = 0.323984         +/- 0.0262       (8.086%)
f               = 1.03569          +/- 0.922        (89.03%)
g               = -0.0108871       +/- 0.01564      (143.7%)
h               = 1.07785          +/- 2.893        (268.4%)
i               = 0.0370345        +/- 0.01607      (43.39%)
j               = -0.155019        +/- 4.971        (3207%)
k               = 1.44905          +/- 19.96        (1377%)
l               = 0.97643          +/- 93.78        (9604%)
a               = 1.77394          +/- 59.76        (3369%)
b               = 0.318447         +/- 0.04522      (14.2%)
c               = 1.97772          +/- 10.63        (537.3%)
d               = 0.03132          +/- 0.2374       (757.8%)
e               = 0.175348         +/- 0.02937      (16.75%)
f               = 0.271247         +/- 6.114        (2254%)
g               = -0.186795        +/- 0.2761       (147.8%)
h               = 2.86585          +/- 2.596        (90.59%)
i               = 0.0629088        +/- 0.3495       (555.5%)
j               = -2.42928         +/- 52.79        (2173%)
k               = 3.41544          +/- 29.61        (867%)
l               = 2.42815          +/- 90.07        (3709%)
a               = 0.274738         +/- 4.567        (1662%)
b               = 0.326723         +/- 0.02241      (6.861%)
c               = 1.19576          +/- 4.996        (417.8%)
d               = -0.0529649       +/- 0.03649      (68.9%)
e               = 0.524963         +/- 0.09558      (18.21%)
f               = 0.538095         +/- 1.718        (319.4%)
g               = -0.0677546       +/- 0.05224      (77.1%)
h               = 2.41413          +/- 1.795        (74.36%)
i               = 0.0692323        +/- 0.07387      (106.7%)
j               = -1.30447         +/- 29.73        (2279%)
k               = 2.54791          +/- 18.21        (714.5%)
l               = 1.83068          +/- 41.05        (2243%)
a               = 0.517661         +/- 1.097        (212%)
b               = 0.22361          +/- 0.02357      (10.54%)
c               = 1.03492          +/- 0.7825       (75.61%)
d               = 0.119713         +/- 72.05        (6.019e+04%)
e               = 1.38148          +/- 756.1        (5.473e+04%)
f               = 0.676741         +/- 241.8        (3.573e+04%)
g               = -0.0206038       +/- 0.01031      (50.05%)
h               = 1.00157          +/- 1.623        (162.1%)
i               = -0.0770817       +/- 133.3        (1.729e+05%)
j               = -0.92969         +/- 1.103        (118.6%)
k               = 0.919114         +/- 0.6305       (68.6%)
l               = 2.09134          +/- 7.361        (352%)
a               = 0.505138         +/- 0.993        (196.6%)
b               = 0.191211         +/- 0.005846     (3.057%)
c               = 0.585063         +/- 0.05994      (10.24%)
d               = 0.197876         +/- 26.58        (1.343e+04%)
e               = 1.13782          +/- 701.9        (6.169e+04%)
f               = 1.09121          +/- 78.05        (7153%)
g               = -0.0230446       +/- 0.01103      (47.86%)
h               = 0.614394         +/- 0.8934       (145.4%)
i               = -0.134862        +/- 125          (9.267e+04%)
j               = -1.09588         +/- 0.3698       (33.74%)
k               = 0.675052         +/- 0.1841       (27.28%)
l               = 0.560408         +/- 1.169        (208.6%)
a               = -0.132601        +/- 7.481        (5642%)
b               = 0.253335         +/- 0.07172      (28.31%)
c               = 0.998048         +/- 14.5         (1453%)
d               = -0.485458        +/- 15.07        (3103%)
e               = 0.603792         +/- 0.2052       (33.99%)
f               = 0.0620924        +/- 2.063        (3322%)
g               = -0.0495271       +/- 0.04495      (90.75%)
h               = 1.75126          +/- 1.898        (108.4%)
i               = 0.52212          +/- 15.12        (2896%)
j               = 1.36403          +/- 26.35        (1932%)
k               = 2.08171          +/- 18.23        (876%)
l               = 0.58289          +/- 6.985        (1198%)
EOF
;

for $line (split(/\n/, $data)) {
	if ($line =~ /^([a-z]) *= *([0-9-.]+)/) {
		push @{$p{$1}}, $2;
	} else {
		die "$line";
	}
}

for ($b = 0; $b < 1; $b += .07) {
	for ($a = 0; $a < 1; $a += .07) {
		for ($i = 0; $i < 8; $i++) {
			$d[$i] = $p{'a'}[$i] * exp(log(abs($a - $p{'b'}[$i])) * $p{'c'}[$i]) +
				$p{'d'}[$i] * exp(log(abs($b - $p{'e'}[$i])) * $p{'f'}[$i]) +
				$p{'g'}[$i] * exp(log($light) * $p{'h'}[$i]) +
				$p{'i'}[$i] + $p{'j'}[$i] * exp(log(abs($a - $p{'b'}[$i])) * $p{'k'}[$i]) * exp(log(abs($b - $p{'c'}[$i])) * $p{'l'}[$i]);
		}

		for ($i = 0; $i < $sides; $i++) {
			$d0 = $d[($i - 1 + $sides) % $sides];
			$d1 = $d[$i];
			$d2 = $d[($i + 1) % $sides];
			$d3 = $d[($i + 2) % $sides];

			$a0 = $ang[($i - 1 + $sides) % $sides];
			$a1 = $ang[$i];
			$a2 = $ang[($i + 1) % $sides];
			$a3 = $ang[($i + 2) % $sides];

			if ($d1 * cos($a1) * $sc > $maxp) {
				$maxp = $d1 * cos($a1) * $sc;
			}
			if ($d1 * cos($a1) * $sc < $minp) {
				$minp = $d1 * cos($a1) * $sc;
			}

			if ($d1 * sin($a1) * $sc > $maxv) {
				$maxv = $d1 * sin($a1) * $sc;
			}
			if ($d1 * sin($a1) * $sc < $minv) {
				$minv = $d1 * sin($a1) * $sc;
			}

			if ($d1 ne "x" && $d2 ne "x") {
				$x0 = ($a + $d0 * cos($a0) * $sc);
				$y0 = ($b + $d0 * sin($a0) * $sc);

				$x1 = ($a + $d1 * cos($a1) * $sc);
				$y1 = ($b + $d1 * sin($a1) * $sc);

				$x2 = ($a + $d2 * cos($a2) * $sc);
				$y2 = ($b + $d2 * sin($a2) * $sc);

				$x3 = ($a + $d3 * cos($a3) * $sc);
				$y3 = ($b + $d3 * sin($a3) * $sc);

				bezier($x0, $y0, $x1, $y1, $x2, $y2, $x3, $y3);
			}

			$xc = $a;
			$yc = $b;

			print scale($xc, $yc) . " 1 0 360 arc fill\n";
		}
	}
}
